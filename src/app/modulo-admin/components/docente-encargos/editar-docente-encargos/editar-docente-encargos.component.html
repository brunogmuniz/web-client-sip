<div class="card card-custom">
  <div class="card-header">
    <h3 class="card-title">
      Editar Encargos: <span class="text-primary">{{ docenteEmEdicaoNome }}</span>
    </h3>
  </div>

  <div class="card-body">

    <div class="p-5 bg-light-primary border border-primary border-dashed rounded mb-6">
      <h5 class="text-gray-800 fw-bold mb-4">
        <i class="la la-plus-circle text-primary fs-2 me-2"></i>
        Adicionar Novo Encargo
      </h5>

      <form [formGroup]="subForm">
        <div class="row align-items-end g-4">
          <div class="col-md-6">
            <label class="form-label text-gray-700 fw-semibold required">Subárea de Conhecimento</label>
            <select formControlName="subareaSelecionada"
                    class="form-select form-select-solid"
                    [class.is-invalid]="cSub['subareaSelecionada'].invalid && cSub['subareaSelecionada'].touched">
              <option [ngValue]="null" disabled>Selecione a subárea...</option>
              <ng-container *ngFor="let grupo of areasAgrupadas | keyvalue">
                <optgroup [label]="grupo.key">
                  <option *ngFor="let sub of grupo.value" [ngValue]="sub">{{ sub.nome }}</option>
                </optgroup>
              </ng-container>
            </select>
            <div *ngIf="cSub['subareaSelecionada'].invalid && cSub['subareaSelecionada'].touched" class="invalid-feedback d-block">
              Campo obrigatório
            </div>
          </div>

          <div class="col-md-3">
            <label class="form-label text-gray-700 fw-semibold required">% Atuação</label>
            <input type="number"
                   formControlName="percentual"
                   class="form-control form-control-solid"
                   placeholder="0.0"
                   min="0.1"
                   max="100"
                   step="0.1"
                   [class.is-invalid]="cSub['percentual'].invalid && cSub['percentual'].touched" />
            <div *ngIf="cSub['percentual'].invalid && cSub['percentual'].touched" class="invalid-feedback d-block">
              <span *ngIf="cSub['percentual'].hasError('required')">Campo obrigatório</span>
              <span *ngIf="cSub['percentual'].hasError('min')">Valor mínimo: 0.1%</span>
              <span *ngIf="cSub['percentual'].hasError('max')">Valor máximo: 100%</span>
            </div>
          </div>

          <div class="col-md-3">
            <button type="button"
                    class="btn btn-success w-100"
                    (click)="adicionarEncargo()"
                    [disabled]="subForm.invalid">
              <i class="la la-plus"></i> Adicionar
            </button>
          </div>
        </div>
      </form>
    </div>

    <div class="separator separator-dashed my-6"></div>

    <div class="table-responsive">
      <table class="table table-row-bordered table-row-gray-300 align-middle gs-3 gy-4">
        <thead>
        <tr class="fw-bold fs-6 text-gray-800 border-bottom-2 border-gray-200">
          <th class="min-w-150px">Área</th>
          <th class="min-w-200px">Subárea</th>
          <th class="min-w-100px text-end">% Atuação</th>
          <th class="min-w-100px text-center">Ação</th>
        </tr>
        </thead>
        <tbody class="fs-6">
        <tr *ngFor="let enc of encargosAtuais; let i = index">
          <td><span class="text-gray-800 fw-semibold">{{ enc.nomeArea }}</span></td>
          <td><span class="text-gray-700">{{ enc.nomeSubarea }}</span></td>
          <td class="text-end">
            <span class="badge badge-light-primary fw-bold fs-6 text-dark">{{ enc.percentual }}%</span>
          </td>
          <td class="text-center">
            <button type="button"
                    class="btn btn-icon btn-light-danger btn-sm"
                    (click)="removerEncargo(i)"
                    title="Remover">
              <i class="la la-trash fs-3"></i>
            </button>
          </td>
        </tr>

        <tr *ngIf="encargosAtuais.length === 0">
          <td colspan="4" class="text-center py-10">
            <div class="d-flex flex-column align-items-center">
              <i class="la la-info-circle fs-3x text-gray-400 mb-3"></i>
              <span class="text-gray-600 fw-semibold fs-5">
                  Nenhum encargo cadastrado. Adicione pelo menos um encargo acima.
                </span>
            </div>
          </td>
        </tr>
        </tbody>

        <tfoot *ngIf="encargosAtuais.length > 0" class="border-top-2 border-gray-200">
        <tr>
          <td colspan="2" class="text-end">
            <span class="text-gray-800 fw-bold fs-5">Total da Carga:</span>
          </td>
          <td class="text-end">
              <span class="badge fw-bold fs-5"
                    [ngClass]="{
                      'badge-success': getTotalCarga() === 100,
                      'badge-danger': getTotalCarga() > 100,
                      'badge-warning': getTotalCarga() < 100
                    }">
                {{ getTotalCarga() | number:'1.1-1' }}%
              </span>
          </td>
          <td></td>
        </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="card-footer d-flex justify-content-between">
    <button type="button" class="btn btn-light-secondary" (click)="cancelar()">
      <i class="la la-times"></i> Cancelar
    </button>
    <button type="button"
            class="btn btn-primary"
            (click)="onSubmit()"
            [disabled]="encargosAtuais.length === 0">
      <i class="la la-save"></i> Salvar Alterações
    </button>
  </div>
</div>
